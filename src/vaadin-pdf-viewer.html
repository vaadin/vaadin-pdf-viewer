<!--
@license
Copyright (c) 2018 Vaadin Ltd.
-->

<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../vaadin-themable-mixin/vaadin-themable-mixin.html">
<link rel="import" href="../../vaadin-element-mixin/vaadin-element-mixin.html">
<link rel="import" href="../../vaadin-license-checker/vaadin-license-checker.html">
<!-- pdf.js enables reading in PDF files and building a JS data representation of it -->
<script src="../../pdfjs-dist/build/pdf.min.js"></script>
<!-- pdf_viewer.js enables rendering a pdf.js -read file into DOM -->
<script src="../../pdfjs-dist/web/pdf_viewer.js"></script>

<dom-module id="vaadin-pdf-viewer">
  <template>
    <style>
      :host {
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 300px;
      }

      :host([hidden]) {
        display: none !important;
      }

      #viewerContainer {
        position: relative;
        display: flex;
        flex: 1;
        overflow: auto;
        justify-content: center;
      }

      .page {
        position: relative;
      }

      .textLayer {
        position: absolute;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        overflow: hidden;
        line-height: 1.0;
      }

      .textLayer>div {
        color: transparent;
        position: absolute;
        white-space: pre;
        cursor: text;
        -webkit-transform-origin: 0% 0%;
        transform-origin: 0% 0%;
      }

      .textLayer .highlight {
        margin: -1px;
        padding: 1px;
      }

      .textLayer .highlight.begin {
        border-radius: 4px 0px 0px 4px;
      }

      .textLayer .highlight.end {
        border-radius: 0px 4px 4px 0px;
      }

      .textLayer .highlight.middle {
        border-radius: 0px;
      }

      .textLayer .endOfContent {
        display: block;
        position: absolute;
        left: 0px;
        top: 100%;
        right: 0px;
        bottom: 0px;
        z-index: -1;
        cursor: default;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      .textLayer .endOfContent.active {
        top: 0px;
      }
    </style>
    <div id="header">
      <span id="title">{{__title}}</span>
    </div>
    <div id="viewerContainer">
      <div id="viewer"></div>
    </div>
  </template>

  <script>
    (function() {

      /**
       * `<vaadin-pdf-viewer>` is a Web Component for rendering PDF files without
       * the need of plugins. You can provide a pdf file to it through the src
       * attribute.
       *
       * ```
       * <vaadin-pdf-viewer src="myfile.pdf"></vaadin-pdf-viewer>
       * ```
       *
       * @memberof Vaadin
       * @mixes Vaadin.ElementMixin
       * @mixes Vaadin.ThemableMixin
       * @demo demo/index.html
       */
      class PdfViewerElement extends Vaadin.ElementMixin(Vaadin.ThemableMixin(Polymer.Element)) {
        static get is() {
          return 'vaadin-pdf-viewer';
        }
        static get version() {
          return '1.0.0-alpha1';
        }

        static get properties() {
          return {
            /**
             * You can set a pdf file that you want to render with src. Note that regular cross
             * site scripting (XSS) rules apply. This means that the file should be on the same
             * server as where the component is run, or that the server where the file is on should
             * be configured to allow loading files from other sites.
             */
            src: String,
            /** 
             * The viewer, which takes care of rendering content into a DOM element
             */
            _viewer: Object,
            /**
             * A represenentation of a document that has been read in. 
             */
            __document: Object,
            /**
             * The title for the PDF shown in the header of component. It uses both the file name and
             * the title in the PDF metadata if available.
             */
            __title: {
              type: String,
              value: "PDF"
            },
            /**
             * Relative filename 
             */
            __filename: String,
            /**
             * The pdf metadata title
             */
            __pdfTitle: String

          };
        }

        static get observers() {
          return [
            '_setTitle(__pdfTitle, __filename)'
          ];
        }

        _setTitle(pdfTitle, filename) {
          if(pdfTitle && filename)Â {
            this.__title = pdfTitle + " - " + filename;
          } else if (pdfTitle) {
            this.__title = pdfTitle;
          } else if (filename) {
            this.__title = filename;
          } else {
            this.__title = "PDF";
          }
        }

        ready() {
          super.ready();
          this._viewer = new pdfjsViewer.PDFViewer({
            container: this.$.viewerContainer,
            textLayerMode: 2,
            viewer: this.$.viewer
          });
          this.$.viewerContainer.addEventListener('pagesinit', () => {
            this._viewer.currentScaleValue = 'auto';
          });
          this.open(this.src);
        }

        open(src) {
          // Is there already a document loaded?
          if (this.__document) {
            // We need to close the current document
            return this.close().then(() => {
              // and start over with opening the new one
              return this.open(src);
            });
          }
          if (!src) {
            // No file given, show nothing.
            return;
          }
          this.setFilename(src);
          this.__document = pdfjsLib.getDocument(src);
          return this.__document.promise.then((pdfDocument) => {
            // Document loaded, specifying document for the viewer.
            this._viewer.setDocument(pdfDocument);
            this.setPdfTitleFromMetadata(pdfDocument);
            this.dispatchEvent(new CustomEvent('document-loaded', {detail: {document: pdfDocument}}));
          }, function (exception) {
            console.error(exception && exception.message);
          });
        }

        setFilename(src) {
          let filename = pdfjsLib.getFilenameFromUrl(src) || src;
          try {
            filename = decodeURIComponent(filename);
          } catch (e) {
            // decodeURIComponent may throw URIError,
            // fall back to using the unprocessed url in that case
          }
          this.__filename = filename;
        }

        setPdfTitleFromMetadata(pdfDocument) {
          const self = this;
          pdfDocument.getMetadata().then(function (data) {
            let pdfTitle;
            const metadata = data.metadata;
            if (metadata && metadata.has('dc:title')) {
              const title = metadata.get('dc:title');
              // Ghostscript sometimes returns 'Untitled', so prevent setting the
              // title to 'Untitled'.
              if (title !== 'Untitled') {
                pdfTitle = title;
              }
            }

            const info = data.info;
            if (!pdfTitle && info && info['Title']) {
              pdfTitle = info['Title'];
            }
            self.__pdfTitle = pdfTitle;
          });
        }
      }

      customElements.define(PdfViewerElement.is, PdfViewerElement);

      /**
       * @namespace Vaadin
       */
      window.Vaadin.PdfViewerElement = PdfViewerElement;

      const devModeCallback = window.Vaadin.developmentModeCallback;
      const licenseChecker = devModeCallback && devModeCallback['vaadin-license-checker'];
      if (typeof licenseChecker === 'function') {
        licenseChecker(PdfViewerElement);
      }

    })();
  </script>
</dom-module>