<!--
@license
Copyright (c) 2018 Vaadin Ltd.
-->

<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../vaadin-themable-mixin/vaadin-themable-mixin.html">
<link rel="import" href="../../vaadin-element-mixin/vaadin-element-mixin.html">
<link rel="import" href="../../vaadin-license-checker/vaadin-license-checker.html">
<link rel="import" href="../../vaadin-text-field/src/vaadin-text-field.html">
<!-- pdf.js enables reading in PDF files and building a JS data representation of it -->
<script src="../../pdfjs-dist/build/pdf.min.js"></script>
<!-- pdf_viewer.js enables rendering a pdf.js -read file into DOM -->
<script src="../../pdfjs-dist/web/pdf_viewer.js"></script>
<!-- this should be loaded only if needed vie pdfjsLib.GlobalWorkerOptions.workerSrc in `ready()`,
     but the file gets optimized away when a project using this component is built. There is
     probably problems still with bundles, which put this file as inline. -->
<script src="../../pdfjs-dist/build/pdf.worker.min.js"></script>

<dom-module id="vaadin-pdf-viewer">
  <template>
    <style>
      :host {
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 300px;
      }

      :host([hidden]) {
        display: none !important;
      }

      #toolbar #currentPage,
      #toolbar #pageSeparator,
      #toolbar #totalPages,
      #toolbar #previousPage,
      #toolbar #nextPage {
        display: none;
      }

      #toolbar.ready #currentPage,
      #toolbar.ready #pageSeparator,
      #toolbar.ready #totalPages,
      #toolbar.ready #previousPage,
      #toolbar.ready #nextPage {
        display: inherit;
      }

      #viewerContainer {
        position: relative;
        display: flex;
        flex: 1;
        overflow: auto;
        justify-content: center;
      }

      .page {
        position: relative;
      }

      .textLayer {
        position: absolute;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        overflow: hidden;
        line-height: 1;
      }

      .textLayer > div {
        color: transparent;
        position: absolute;
        white-space: pre;
        cursor: text;
        -webkit-transform-origin: 0% 0%;
        transform-origin: 0% 0%;
      }

      .textLayer .highlight {
        margin: -1px;
        padding: 1px;
      }

      .textLayer .highlight.begin {
        border-radius: 4px 0 0 4px;
      }

      .textLayer .highlight.end {
        border-radius: 0 4px 4px 0;
      }

      .textLayer .highlight.middle {
        border-radius: 0;
      }

      .textLayer .endOfContent {
        display: block;
        position: absolute;
        left: 0;
        top: 100%;
        right: 0;
        bottom: 0;
        z-index: -1;
        cursor: default;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }

      .textLayer .endOfContent.active {
        top: 0;
      }

      #header {
        display: flex;
        flex-direction: row;
        align-items: baseline;
      }

      #currentPage {
        align-self: baseline;
      }

      #headerSpacer {
        flex: 1;
      }

      #header #currentPage,
      #header #pageSeparator,
      #header #totalPages,
      #header #previousPage,
      #header #nextPage {
        display: none;
      }

      #header.ready #currentPage,
      #header.ready #pageSeparator,
      #header.ready #totalPages,
      #header.ready #previousPage,
      #header.ready #nextPage {
        display: inherit;
      }
    </style>
    <div id="toolbar" part="toolbar">
      <span id="title" part="toolbar-text toolbar-title">{{__title}}</span>
      <span id="toolbarSpacer" part="toolbar-spacer"></span>
      <vaadin-text-field id="currentPage" part="toolbar-current-page" value="{{__currentPage}}" on-change="__pageChange"></vaadin-text-field>
      <span id="pageSeparator" part="toolbar-text toolbar-page-separator">/</span>
      <span id="totalPages" part="toolbar-text toolbar-total-pages">{{__totalPages}}</span>
      <button id="previousPage" part="toolbar-button toolbar-button-previous-page" on-click="__previousPage"></button>
      <button id="nextPage" part="toolbar-button toolbar-button-next-page" on-click="__nextPage"></button>
    </div>
    <div id="viewerContainer" part="viewer-container">
      <div id="viewer" part="viewer"></div>
    </div>
  </template>

  <script>
    (function() {

      /**
       * `<vaadin-pdf-viewer>` is a Web Component for rendering PDF files without
       * the need of plugins. You can provide a pdf file to it through the src
       * attribute.
       *
       * ```
       * <vaadin-pdf-viewer src="myfile.pdf"></vaadin-pdf-viewer>
       * ```
       *
       * @memberof Vaadin
       * @mixes Vaadin.ElementMixin
       * @mixes Vaadin.ThemableMixin
       * @demo demo/index.html
       */
      class PdfViewerElement extends Vaadin.ElementMixin(Vaadin.ThemableMixin(Polymer.Element)) {
        static get is() {
          return 'vaadin-pdf-viewer';
        }
        static get version() {
          return '1.0.0-alpha1';
        }

        static get properties() {
          return {
            /**
             * You can set a pdf file that you want to render with src. Note that regular cross
             * site scripting (XSS) rules apply. This means that the file should be on the same
             * server as where the component is run, or that the server where the file is on should
             * be configured to allow loading files from other sites.
             */
            src: {
              type: String,
              observer: '__srcChanged'
            },
            /**
             * The viewer, which takes care of rendering content into a DOM element
             */
            __viewer: Object,
            /**
             * A represenentation of a document that has been read in.
             */
            __document: Object,
            /**
             * The title for the PDF shown in the toolbar of component. It uses both the file name and
             * the title in the PDF metadata if available.
             */
            __title: {
              type: String,
              value: 'PDF'
            },
            /**
             * Relative filename
             */
            __filename: String,
            /**
             * The pdf metadata title
             */
            __pdfTitle: String,
            /**
             * The current page visible viewed right now
             */
            __currentPage: {
              type: Number,
              value: 1
            },
            /**
             * Total amount of pages in an opened document
             */
            __totalPages: Number

          };
        }

        static get observers() {
          return [
            '__setTitle(__pdfTitle, __filename)'
          ];
        }

        __setTitle(pdfTitle, filename) {
          if (pdfTitle && filename) {
            this.__title = pdfTitle + ' - ' + filename;
          } else if (pdfTitle) {
            this.__title = pdfTitle;
          } else if (filename) {
            this.__title = filename;
          } else {
            this.__title = 'PDF';
          }
        }

        ready() {
          super.ready();
          /* global pdfjsViewer:true */
          this.__viewer = new pdfjsViewer.PDFViewer({
            container: this.$.viewerContainer,
            textLayerMode: 2,
            viewer: this.$.viewer
          });
          this.$.viewerContainer.addEventListener('pagesinit', () => {
            this.__viewer.currentScaleValue = 'auto';
          });
          this.$.viewerContainer.addEventListener('pagechange', (event) => {
            this.__currentPage = event.pageNumber;
            this.__updatePageNumberStates();
          });
          pdfjsLib.GlobalWorkerOptions.workerSrc = Polymer.ResolveUrl.resolveUrl("../../pdfjs-dist/build/pdf.worker.min.js", PdfViewerElement.importPath);
        }

        open(src) {
          // Is there already a document loaded?
          if (this.__document) {
            // We need to close the current document
            return this.close().then(() => {
              // and start over with opening the new one
              return this.open(src);
            });
          }
          if (!src) {
            // No file given, show nothing.
            return;
          }
          this.__setFilename(src);
          /* global pdfjsLib:true */
          this.__document = pdfjsLib.getDocument(src);
          return this.__document.promise.then((pdfDocument) => {
            // Document loaded, specifying document for the viewer.
            this.__viewer.setDocument(pdfDocument);
            this.__setPdfTitleFromMetadata(pdfDocument);
            this.$.toolbar.classList.add('ready');
            this.__totalPages = pdfDocument.numPages;
            this.__updatePageNumberStates();
            this.dispatchEvent(new CustomEvent('document-loaded', {
              detail: {
                document: pdfDocument
              }
            }));
          }, function(exception) {
            console.error(exception && exception.message);
          });
        }

        __srcChanged(newSrc) {
          this.open(newSrc);
        }

        /**
         * Closes opened PDF document.
         * @returns {Promise} - Returns the promise, which is resolved when all
         *                      destruction is completed.
         */
        close() {
          if (!this.__document) {
            return Promise.resolve();
          }

          var promise = this.__document.destroy();
          if (this.__document) {
            this.__document = null;
            this.__viewer.setDocument(null);
          }
          return promise;
        }

        __setFilename(src) {
          /* global pdfjsLib:true */
          let filename = pdfjsLib.getFilenameFromUrl(src) || src;
          try {
            filename = decodeURIComponent(filename);
          } catch (e) {
            // decodeURIComponent may throw URIError,
            // fall back to using the unprocessed url in that case
          }
          this.__filename = filename;
        }

        __setPdfTitleFromMetadata(pdfDocument) {
          pdfDocument.getMetadata().then((data) => {
            let pdfTitle;
            const metadata = data.metadata;
            if (metadata && metadata.has('dc:title')) {
              const title = metadata.get('dc:title');
              // Ghostscript sometimes returns 'Untitled', so prevent setting the
              // title to 'Untitled'.
              if (title !== 'Untitled') {
                pdfTitle = title;
              }
            }

            const info = data.info;
            if (!pdfTitle && info && info['Title']) {
              pdfTitle = info['Title'];
            }
            this.__pdfTitle = pdfTitle;
          });
        }

        __updatePageNumberStates() {
          this.$.previousPage.disabled = (this.__currentPage == 1);
          this.$.nextPage.disabled = (this.__currentPage == this.__totalPages);
        }

        __pageChange(event) {
          let page = parseInt(this.$.currentPage.value, 10);
          if (isNaN(page)) {
            page = this.__viewer.currentPageNumber;
            this.$.currentPage.value = page;
          }
          if (page < 1) {
            page = 1;
          }
          if (page > this.__totalPages) {
            page = this.__totalPages;
          }
          this.__viewer.currentPageNumber = page;
        }

        _getPage() {
          return this.__viewer.currentPageNumber;
        }

        __previousPage() {
          this.__viewer.currentPageNumber--;
        }

        __nextPage() {
          this.__viewer.currentPageNumber++;
        }
      }

      customElements.define(PdfViewerElement.is, PdfViewerElement);

      /**
       * @namespace Vaadin
       */
      window.Vaadin.PdfViewerElement = PdfViewerElement;

      const devModeCallback = window.Vaadin.developmentModeCallback;
      const licenseChecker = devModeCallback && devModeCallback['vaadin-license-checker'];
      if (typeof licenseChecker === 'function') {
        licenseChecker(PdfViewerElement);
      }

    })();
  </script>
</dom-module>