<!--
@license
Copyright (c) 2018 Vaadin Ltd.
-->

<link rel="import" href="../../polymer/polymer-element.html">
<link rel="import" href="../../vaadin-themable-mixin/vaadin-themable-mixin.html">
<link rel="import" href="../../vaadin-element-mixin/vaadin-element-mixin.html">
<link rel="import" href="../../vaadin-license-checker/vaadin-license-checker.html">
<!-- pdf.js enables reading in PDF files and building a JS data representation of it -->
<script src="../../pdfjs-dist/build/pdf.min.js"></script>
<!-- pdf_viewer.js enables rendering a pdf.js -read file into DOM -->
<script src="../../pdfjs-dist/web/pdf_viewer.js"></script>

<dom-module id="vaadin-pdf-viewer">
  <template>
    <style>
      :host {
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 300px;
      }

      :host([hidden]) {
        display: none !important;
      }

      #viewerContainer {
        position: relative;
        display: flex;
        flex: 1;
        overflow: auto;
        justify-content: center;
      }
    </style>

    <div id="viewerContainer">
      <div id="viewer"></div>
    </div>
  </template>

  <script>
    (function() {

      /**
       * `<vaadin-pdf-viewer>` is a Web Component for rendering PDF files without
       * the need of plugins. You can provide a pdf file to it through the src
       * attribute.
       *
       * ```
       * <vaadin-pdf-viewer src="myfile.pdf"></vaadin-pdf-viewer>
       * ```
       *
       * @memberof Vaadin
       * @mixes Vaadin.ElementMixin
       * @mixes Vaadin.ThemableMixin
       * @demo demo/index.html
       */
      class PdfViewerElement extends Vaadin.ElementMixin(Vaadin.ThemableMixin(Polymer.Element)) {
        static get is() {
          return 'vaadin-pdf-viewer';
        }
        static get version() {
          return '1.0.0-alpha1';
        }

        static get properties() {
          return {
            /**
             * You can set a pdf file that you want to render with src. Note that regular cross
             * site scripting (XSS) rules apply. This means that the file should be on the same
             * server as where the component is run, or that the server where the file is on should
             * be configured to allow loading files from other sites.
             */
            src: String,
            /** 
             * The viewer, which takes care of rendering content into a DOM element
             */
            _viewer: Object,
            /**
             * A represenentation of a document that has been read in. 
             */
            _document: Object
          };
        }

        ready() {
          super.ready();
          this._viewer = new pdfjsViewer.PDFViewer({
            container: this.$.viewerContainer,
            textLayerMode: 0,
            viewer: this.$.viewer
          });
          this.$.viewerContainer.addEventListener('pagesinit', () => {
            this._viewer.currentScaleValue = 'auto';
          });
          this.open(this.src);
        }

        open(src) {
          // Is there already a document loaded?
          if (this._document) {
            // We need to close the current document
            return this.close().then(() => {
              // and start over with opening the new one
              return this.open(src);
            });
          }
          if (!src) {
            // No file given, show nothing.
            return;
          }
          this._document = pdfjsLib.getDocument(src);
          return this._document.promise.then((pdfDocument) => {
            // Document loaded, specifying document for the viewer.
            this._viewer.setDocument(pdfDocument);
          }, function (exception) {
            console.error(exception && exception.message);
          });
        }
      }

      customElements.define(PdfViewerElement.is, PdfViewerElement);

      /**
       * @namespace Vaadin
       */
      window.Vaadin.PdfViewerElement = PdfViewerElement;

      const devModeCallback = window.Vaadin.developmentModeCallback;
      const licenseChecker = devModeCallback && devModeCallback['vaadin-license-checker'];
      if (typeof licenseChecker === 'function') {
        licenseChecker(PdfViewerElement);
      }

    })();
  </script>
</dom-module>